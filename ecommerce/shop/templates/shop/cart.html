{% extends 'shop/base.html' %} {% block content %}
<div class="container py-5">
  <div class="row">
    <div class="col-lg-8">
      <h2 class="mb-4">Your Shopping Cart</h2>

      <!-- Debug Info (remove in production) -->
      {% if cart_debug %}
      <div class="alert alert-info small mb-3">
        <strong>Debug:</strong> Cart session contains: {{ cart_debug|length }} item(s)
      </div>
      {% endif %}

      <!-- Cart Items -->
      {% for item in cart_items %}
      <div class="card mb-3">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-2">
              <img
                src="{{ item.image }}"
                class="img-fluid rounded"
                alt="{{ item.name }}"
              />
            </div>
            <div class="col-md-4">
              <h5 class="mb-1">{{ item.name }}</h5>
              <p class="text-muted mb-0">Quantity: {{ item.quantity }}</p>
            </div>
            <div class="col-md-3">
              <form method="POST" action="{% url 'update_cart' item.id %}" class="d-inline update-cart-form">
                {% csrf_token %}
                <div class="input-group" style="width: 120px">
                  <button 
                    class="btn btn-outline-secondary" 
                    type="button"
                    onclick="updateQuantity({{ item.id }}, -1)"
                  >
                    -
                  </button>
                  <input 
                    type="number" 
                    class="form-control text-center quantity-input" 
                    name="quantity"
                    value="{{ item.quantity }}" 
                    min="1"
                    max="10"
                    id="quantity-{{ item.id }}"
                    onchange="updateCartItem({{ item.id }})"
                  />
                  <button 
                    class="btn btn-outline-secondary" 
                    type="button"
                    onclick="updateQuantity({{ item.id }}, 1)"
                  >
                    +
                  </button>
                </div>
              </form>
            </div>
            <div class="col-md-2">
              <h5 class="mb-0">£{{ item.price|floatformat:2 }}</h5>
              <small class="text-muted">Total: £{{ item.total|floatformat:2 }}</small>
            </div>
            <div class="col-md-1">
              <form method="POST" action="{% url 'remove_from_cart' item.id %}" class="d-inline remove-cart-form">
                {% csrf_token %}
                <button 
                  type="submit" 
                  class="btn btn-link text-danger"
                  onclick="return confirm('Remove {{ item.name }} from cart?')"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="card mb-3">
        <div class="card-body text-center py-5">
          <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
          <h4>Your cart is empty</h4>
          <p class="text-muted">Add some products to get started!</p>
          <a href="/products/" class="btn btn-primary">
            <i class="fas fa-arrow-left me-2"></i>Continue Shopping
          </a>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Order Summary -->
    <div class="col-lg-4">
      <div class="card shadow">
        <div class="card-body">
          <h4 class="card-title mb-4">Order Summary</h4>

          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Subtotal</span>
            <span id="cart-subtotal">£{{ subtotal|floatformat:2 }}</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Shipping</span>
            <span id="cart-shipping">£{{ shipping|floatformat:2 }}</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Tax</span>
            <span id="cart-tax">£{{ tax|floatformat:2 }}</span>
          </div>

          <hr />

          <div class="d-flex justify-content-between mb-4">
            <strong>Total</strong>
            <strong class="text-primary" id="cart-total">£{{ total|floatformat:2 }}</strong>
          </div>

          <div class="d-grid gap-2">
            <a href="/checkout/" class="btn btn-primary btn-lg">
              <i class="fas fa-lock me-2"></i>
              Proceed to Checkout
            </a>
            <a href="/products/" class="btn btn-outline-primary">
              <i class="fas fa-arrow-left me-2"></i>
              Continue Shopping
            </a>
          </div>

          <div class="mt-4">
            <p class="text-muted small">
              <i class="fas fa-shield-alt me-2"></i>
              Secure checkout • 30-day returns • Free shipping on orders over
              £50
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function updateQuantity(productId, change) {
    const input = document.getElementById('quantity-' + productId);
    let currentQuantity = parseInt(input.value) || 1;
    let newQuantity = currentQuantity + change;
    
    if (newQuantity < 1) newQuantity = 1;
    if (newQuantity > 10) newQuantity = 10;
    
    input.value = newQuantity;
    updateCartItem(productId);
  }

  function updateCartItem(productId) {
    const form = document.querySelector(`#quantity-${productId}`).closest('form');
    const formData = new FormData(form);
    const quantity = formData.get('quantity');
    
    // Update via AJAX
    fetch(form.action, {
      method: 'POST',
      headers: {
        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update totals
        document.getElementById('cart-subtotal').textContent = '£' + data.subtotal.toFixed(2);
        document.getElementById('cart-shipping').textContent = '£' + data.shipping.toFixed(2);
        document.getElementById('cart-tax').textContent = '£' + data.tax.toFixed(2);
        document.getElementById('cart-total').textContent = '£' + data.total.toFixed(2);
        
        // Update item total
        const itemRow = form.closest('.card');
        const priceElement = itemRow.querySelector('.col-md-2 h5');
        const price = parseFloat(priceElement.textContent.replace('£', ''));
        const quantity = parseInt(document.getElementById('quantity-' + productId).value);
        const totalPrice = price * quantity;
        const totalElement = itemRow.querySelector('.col-md-2 small');
        if (totalElement) {
          totalElement.textContent = 'Total: £' + totalPrice.toFixed(2);
        }
        
        // Reload page to show updated cart
        setTimeout(() => {
          window.location.reload();
        }, 500);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      // Fallback to form submission
      form.submit();
    });
  }

  // Handle remove form submission
  document.querySelectorAll('.remove-cart-form').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (confirm('Remove this item from cart?')) {
        const formData = new FormData(this);
        
        fetch(this.action, {
          method: 'POST',
          headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Remove item from DOM
            this.closest('.card').remove();
            
            // Update totals
            document.getElementById('cart-subtotal').textContent = '£' + data.subtotal.toFixed(2);
            document.getElementById('cart-shipping').textContent = '£' + data.shipping.toFixed(2);
            document.getElementById('cart-tax').textContent = '£' + data.tax.toFixed(2);
            document.getElementById('cart-total').textContent = '£' + data.total.toFixed(2);
            
            // Update cart badge
            const cartBadge = document.querySelector('.navbar .badge');
            if (cartBadge) {
              cartBadge.textContent = data.cart_count || 0;
            }
            
            // Check if cart is empty
            const cartItems = document.querySelectorAll('.card.mb-3');
            if (cartItems.length === 0) {
              window.location.reload();
            }
          }
        })
        .catch(error => {
          console.error('Error:', error);
          // Fallback to form submission
          this.submit();
        });
      }
    });
  });
</script>
{% endblock %}
